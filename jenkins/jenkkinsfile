// Define variable
def myVariable = "foo"

pipeline {
  agent any
    
  stages {
    stage('Checkout Code') {
        agent { 
        docker { image 'node:20.9.0-alpine3.18' }
      }
      steps {
        git(url: 'https://github.com/hamidrgholipour/node-project-CICD-k8S', branch: 'master')
      }
    }  
    
    stage('test') {
        agent { 
        docker { image 'node:20.9.0-alpine3.18' }
      }        
      steps {
        sh """
          cd app
          npm install
          npm run test
        """ 
      }
      post {
        always {
            archiveArtifacts artifacts: 'app/junit.xml', fingerprint: true
            junit 'app/junit.xml'
            }
        }
    }  
    stage('Build') {

      steps {
        sh 'echo Bulding'
        script{
          myapp = docker.build( "node-app:v4")
        }
      }
    }
    stage('deploy') {
      steps {
        sh 'echo Deploying'

      }
    }

  }
}
